package mess.messagecontrolservice.service.messages;

import mess.messagecontrolservice.dto.KafkaMessageDTO;
import mess.messagecontrolservice.entity.MessageEntity;
import mess.messagecontrolservice.repository.MessageRepository;
import mess.messagecontrolservice.service.KafkaMessageInfo;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.stereotype.Component;

import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.util.function.Consumer;

@Component
@Scope("singleton")
public class MessageActionResolver {
    private static MessageRepository repository;

    private MessageActionResolver(@Autowired MessageRepository _repository) {
        repository = _repository;
    }

    public static void resolveAction(KafkaMessageInfo messageInfo) {
        Consumer<KafkaMessageDTO> consumer = switch (messageInfo.action()) {
            case create -> MessageActionResolver::doCreate;
            case get -> MessageActionResolver::doGet;
            case update -> MessageActionResolver::doUpdate;
            case delete -> MessageActionResolver::doDelete;
        };
        doAction(consumer, messageInfo.messageDTO());
    }

    public static void doAction(Consumer<KafkaMessageDTO> action, KafkaMessageDTO messageDTO) {
        action.accept(messageDTO);
    }

    private static void doCreate(KafkaMessageDTO messageDTO) { // todo: check for exceptions
        repository.insert(MessageEntity.builder()
                .text(messageDTO.text())
                .isRead(false)
                .userId(messageDTO.userId())
                .chatId(messageDTO.chatId())
                .build()
        );
    }

    private static void doUpdate(KafkaMessageDTO messageDTO) {
        var entity = repository.findById(messageDTO.id()).orElseThrow();
        entity.setText(messageDTO.text());
        repository.save(entity);
    }

    private static void doDelete(KafkaMessageDTO messageDTO) {
        repository.deleteById(messageDTO.id());
    }

    private static void doGet(KafkaMessageDTO messageDTO) {  // todo: change for kafka producer
        repository.findById(messageDTO.id()).orElseThrow();
    }
}
